---
title: "doughnut"
format: html
---

```{r}
library(readr)
# --- Set 1: Book Files ---
# Read, select columns, and force Time to be character
book_adj <- read_csv("~/Downloads/Book(Sheet1)-3.csv") %>% 
  select(1:5) %>%
  mutate(Time = as.character(TimeAdj)) %>%  # Convert to text and rename to 'Time'
  select(-TimeAdj) # Remove the old name if it still exists

book_unadj <- read_csv("~/Downloads/Book 1(Sheet1)-2.csv")

# --- Set 2: Run Files ---
# Read and force Time to be character
run_adj <- read_csv("~/Downloads/5KRun1.csv") %>%
  mutate(Time = as.character(Time))|> select(1:4) # Ensure this is text

run_unadj <- read_csv("~/Downloads/5KRunUnadj1.csv") |> select(1:4)

# --- Combine (Join) them ---
X5KRun1 <- bind_rows(book_adj, run_adj)
X5KRunUnadj1 <- bind_rows(book_unadj, run_unadj)

# --- Clean Unadjusted ---
X5KRunUnadj1 <- X5KRunUnadj1[, colSums(is.na(X5KRunUnadj1)) < nrow(X5KRunUnadj1)]
```


# adjusted dataset
```{r}
X5KRun1$Time <- as.character(X5KRun1$Time)
fix_time <- function(x) {
  x <- as.character(x)

  parts <- strsplit(x, ":", fixed = TRUE)

  out <- vapply(parts, function(p) {
    if (length(p) == 3 && p[3] == "00") {
      # mm:ss:00  ->  00:mm:ss
      sprintf("00:%02d:%02d", as.integer(p[1]), as.integer(p[2]))
    } else if (length(p) == 3) {
      # already hh:mm:ss, just pad
      sprintf("%02d:%02d:%02d", as.integer(p[1]), as.integer(p[2]), as.integer(p[3]))
    } else {
      NA_character_
    }
  }, character(1))

  out
}

X5KRun1$Time <- fix_time(X5KRun1$Time)
```

# time_sec culumn
```{r}
X5KRun1$time_sec <- with(
  as.data.frame(do.call(rbind, strsplit(X5KRun1$Time, ":"))),
  as.integer(V1) * 3600 + as.integer(V2) * 60 + as.integer(V3)
)
```


# unadjusted dataset
```{r}
X5KRunUnadj1$Time <- as.character(X5KRunUnadj1$Time)
fix_time <- function(x) {
  x <- as.character(x)

  parts <- strsplit(x, ":", fixed = TRUE)

  out <- vapply(parts, function(p) {
    if (length(p) == 3 && p[3] == "00") {
      # mm:ss:00  ->  00:mm:ss
      sprintf("00:%02d:%02d", as.integer(p[1]), as.integer(p[2]))
    } else if (length(p) == 3) {
      # already hh:mm:ss, just pad
      sprintf("%02d:%02d:%02d", as.integer(p[1]), as.integer(p[2]), as.integer(p[3]))
    } else {
      NA_character_
    }
  }, character(1))

  out
}

X5KRunUnadj1$Time <- fix_time(X5KRunUnadj1$Time)
```

# time_sec culumn
```{r}
X5KRunUnadj1$time_sec <- with(
  as.data.frame(do.call(rbind, strsplit(X5KRunUnadj1$Time, ":"))),
  as.integer(V1) * 3600 + as.integer(V2) * 60 + as.integer(V3)
)
```

# time diff
```{r}
# time diff
library(dplyr)

df_diff <- X5KRun1 %>%
  inner_join(X5KRunUnadj1 %>% select(`Race Number`, time_sec),
             by = "Race Number",
             suffix = c("_adj", "_unadj")) %>%
  # The difference is Unadjusted (raw time) minus Adjusted (time after donuts)
  mutate(time_diff_sec = time_sec_unadj - time_sec_adj)
```


# doughnut table
```{r}
bonus_tbl <- data.frame(
  donuts = 1:40,
  bonus = c(
    "00:00:15","00:00:45","00:01:30","00:02:30","00:03:30","00:04:30",
    "00:05:30","00:06:30","00:07:30","00:10:30","00:11:30","00:12:30",
    "00:13:30","00:14:30","00:17:30","00:18:30","00:19:30","00:20:30",
    "00:21:30","00:24:30","00:25:30","00:26:30","00:27:30","00:28:30",
    "00:31:30","00:32:30","00:33:30","00:34:30","00:35:30","00:38:30",
    "00:39:30","00:40:30","00:41:30","00:42:30","00:45:30","00:46:30",
    "00:47:30","00:48:30","00:49:30","00:52:30"
  )
)

library(lubridate)
bonus_tbl$bonus_sec <- as.numeric(hms(bonus_tbl$bonus))

```


# number of doughnuts
```{r}
# number of doughnuts
# This counts how many bonus milestones from the table the runner actually achieved
df_diff$donuts <- sapply(df_diff$time_diff_sec, function(x) {
  if (is.na(x) || x <= 0) return(0)
  
  # sum up how many rows in the bonus table are less than or equal to the time saved
  count <- sum(x >= bonus_tbl$bonus_sec)
  return(count)
})

# SAFETY FILTER: 
# If your data has errors (like a runner matched with the wrong time), 
# this removes people with impossible donut counts (e.g., > 13).
df_diff <- df_diff %>% filter(donuts <= 13)
```


# results
```{r}
library(ggplot2)

ggplot(df_diff, aes(x = donuts)) +
  geom_bar(fill = "#d95f02") +
  labs(
    title = "Distribution of Donuts Eaten",
    x = "Number of Donuts",
    y = "Number of Runners"
  ) +
  theme_minimal()
```

```{r}
ggplot(df_diff, aes(x = time_sec_unadj, y = time_sec_adj)) +
  geom_point(alpha = 0.7, color = "#2c7fb8") +
  # Adds a reference line where Adjusted = Original (0 donuts eaten)
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "red") +
  labs(
    title = "Original vs. Adjusted Time",
    subtitle = "Points below the red line represent time saved by eating donuts",
    x = "Original Time (seconds)",
    y = "Adjusted Time (seconds)"
  ) +
  theme_minimal()
```

```{r}
# 1. Create a new rank column based on the CORRECT column name (time_sec_adj)
df_diff$time_rank <- rank(df_diff$time_sec_adj, ties.method = "min")

# 2. Cut based on the new time_rank
# Adjust the 'breaks' if your total number of runners (383) exceeds the previous limit
df_diff$rank_group <- cut(df_diff$time_rank, breaks = c(0, 10, 50, 100, 700))

# 3. Plot the boxplot
library(ggplot2)
ggplot(df_diff, aes(x = rank_group, y = donuts)) +
  geom_boxplot(fill = "lightblue") +
  labs(
    title = "Donuts Eaten by Finish Rank Group",
    subtitle = "Ranked by Final Adjusted Time",
    x = "Finish Rank Group (1 = Fastest)",
    y = "Number of Donuts"
  ) +
  theme_minimal()
```

```{r}
library(ggplot2)

ggplot(df_diff, aes(x = donuts, y = time_sec_adj)) +
  geom_point(fill = "#d95f02") +
  geom_smooth() +
  labs(
    title = "Distribution of Donuts Eaten",
    x = "Number of Donuts",
    y = "Time Adj"
  ) +
  theme_minimal()
```


```{r}
df_diff2 <- df_diff |> filter(donuts > 0)
ggplot(df_diff2, aes(x = donuts, y = Position)) +
  geom_point(fill = "#d95f02") +
  geom_smooth() +
  labs(
    title = "Distribution of Donuts Eaten without triathletes",
    x = "Number of Donuts",
    y = "time adj"
  ) +
  theme_minimal()
```

